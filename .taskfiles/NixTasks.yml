version: "3"

tasks:

  install-nix:
    desc: Install Nix-Shell
    cmds:
    - echo "Installing Nix..."
    - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix/tag/${VERSION} | sh -s -- install --no-confirm
    - echo "Nix installed successfully."
    env:
      # TODO: Add renovate tag to this task | https://github.com/DeterminateSystems/nix-installer/releases
      VERSION: "v0.16.0"
    status:
    - "command -v nix >/dev/null 2>&1"

  setup-home-manager:
    desc: "Set up Home Manager"
    cmds:
    - echo "Setting up Home Manager..."
    - nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    - nix-channel --update
    - echo "Home Manager set up successfully."
    status:
    - command -v home-manager >/dev/null 2>&1
    deps: [install-nix]

  remove-etc-files:
    desc: "Remove /etc files"
    cmds:
    - echo "Removing /etc files..."
    - sudo mv /etc/nix/nix.conf /etc/nix/nix.conf.before-darwin-nix
    - sudo mv /etc/zshenv /etc/zshenv.before-darwin-nix
    - echo "Removed /etc files successfully."
    status:
    - "test ! -d /etc/nix/nix.conf"
    - "test ! -d /etc/zshenv"

  # install-home-manager:
  #   desc: "Install Home Manager"
  #   cmds:
  #   - echo "Installing Home Manager..."
  #   - "nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager"
  #   - "nix-channel --update"
  #   - echo "This can hang for a while, please be patient..."
  #   - "nix-shell '<home-manager>' -A install"
  #   - echo "Home Manager installed successfully."
  #   status:
  #   - check-home-manager

  # TODO: This should be done in flakes
  # https://github.com/LnL7/nix-darwin#flakes
  install-nix-darwin:
    desc: "Install nix-darwin"
    cmds:
    - echo "Installing nix-darwin..."
    - echo "This can hang for a while, please be patient..."
    - nix-shell -p darwin-rebuild --run 'darwin-rebuild switch --flake .#mac'
    - echo "nix-darwin installed successfully."
    status:
    - command -v darwin-rebuild >/dev/null 2>&1
    deps: [install-nix, setup-home-manager, remove-etc-files]

  setup-all:
    desc: "Set up Nix, Home Manager, and nix-darwin"
    cmds:
    - task: install-nix
    - task: setup-home-manager
    - task: remove-etc-files
    - task: install-nix-darwin
    - echo "All set up! Run 'darwin-rebuild switch' to apply changes."
