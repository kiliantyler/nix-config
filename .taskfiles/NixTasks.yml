version: "3"

tasks:

  check-nix:
    desc: "Check if Nix is already installed"
    cmds:
    - "command -v nix >/dev/null 2>&1 && echo 'Nix is already installed' || exit 1"
    status:
    - "command -v nix >/dev/null 2>&1"

  install-nix:
    desc: Install Nix-Shell
    cmds:
    - echo "Installing Nix..."
    - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix/tag/${VERSION} | sh -s -- install --no-confirm
    - echo "Nix installed successfully."
    env:
      # TODO: Add renovate tag to this task | https://github.com/DeterminateSystems/nix-installer/releases
      VERSION: "v0.16.0"
    status:
    - check-nix

  check-home-manager:
    desc: "Check if Home Manager is already installed"
  cmds:
  - "command -v home-manager >/dev/null 2>&1 && echo 'Home Manager is already installed' || exit 1"
  status:
  - "command -v home-manager >/dev/null 2>&1"

  setup-home-manager:
    desc: "Set up Home Manager"
    cmds:
    - echo "Setting up Home Manager..."
    - nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
    - nix-channel --update
    - echo "Home Manager set up successfully."
    status:
    - check-home-manager

  # install-home-manager:
  #   desc: "Install Home Manager"
  #   cmds:
  #   - echo "Installing Home Manager..."
  #   - "nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager"
  #   - "nix-channel --update"
  #   - echo "This can hang for a while, please be patient..."
  #   - "nix-shell '<home-manager>' -A install"
  #   - echo "Home Manager installed successfully."
  #   status:
  #   - check-home-manager

  check-nix-darwin:
    desc: "Check if nix-darwin is already installed"
    cmds:
    - "command -v darwin-rebuild >/dev/null 2>&1 && echo 'nix-darwin is already installed' || exit 1"
    status:
    - "command -v darwin-rebuild >/dev/null 2>&1"

  # TODO: This should be done in flakes
  # https://github.com/LnL7/nix-darwin#flakes
  install-nix-darwin:
    desc: "Install nix-darwin"
    cmds:
    - echo "Installing nix-darwin..."
    - echo "This can hang for a while, please be patient..."
    - nix-shell -p darwin-rebuild --run 'darwin-rebuild switch --flake .#mac'
    - echo "nix-darwin installed successfully."
    status:
    - check-nix-darwin

  setup-all:
    desc: "Set up Nix, Home Manager, and nix-darwin"
    cmds:
    - task: install-nix
    - task: install-home-manager
    - task: install-nix-darwin
    - echo "All set up! Run 'darwin-rebuild switch' to apply changes."
    status:
    - check-nix
    - check-home-manager
    - check-nix-darwin
